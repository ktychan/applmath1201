\documentclass[12pt, letterpaper]{book}


% ----------------------------------------
% 
% Course information
%
% ----------------------------------------
\def\theauthor{Kelvin Chan}
\def\theinstitute{Western University, Ontario}
\def\thecourseterm{Winter}
\def\thecourseyear{2025}
\def\thecoursesubj{ApplMath}
\def\thecoursesubject{Applied Math}
\def\thecoursenumb{1201}
\def\thecoursesect{001}
\def\thecoursename{Calculus \& Probability with Biological Applications}
\def\thecoursetitle{\thecoursesubj~\thecoursenumb:~\thecoursename}
\def\thecoursecoordinator{}
\def\thecourseinstructor{\theauthor}
\def\thecourselms{BrightSpace}

\def\thecoursetextbooktitle{}
\def\thecoursetextbookurl{}
\def\thecoursetextbookpublisher{}
\def\thecoursetextbook{}

% ------------------------------------------------------------
%
%             TITLE
%
% ------------------------------------------------------------
\title{\thecoursetitle}
\author{\theauthor}
\date{\today}


% ------------------------------------------------------------
%
%             PAGE SETUP
%
% ------------------------------------------------------------
\usepackage[margin=0.75in, top=0.25in, bottom=0.25in, nofoot, nomarginpar, includehead, includefoot, headheight=15pt, footskip=5pt]{geometry}

% header and footers
\usepackage{ifdraft}
\usepackage{fancyhdr} % must be loaded after geometry
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyhead[OR, EL]{\small Page~\thepage}
  \renewcommand{\headrulewidth}{0pt}
  \ifdraft{
      \fancyhead[OL,ER]{\textcolor{red}{DRAFT MODE ON}}
    }
}

% base style for all pages
\fancypagestyle{base}{
  \fancyhf{}
  \fancyhead[OR, EL]{\small Page~\thepage}
  \renewcommand{\headrulewidth}{0pt}
  \ifdraft{
      \fancyhead[OL,ER]{\textcolor{red}{DRAFT MODE ON}}
    }
}
\pagestyle{base}

% base style for the first page of a chapter
\newcommand{\firstpageheader}{}
\fancypagestyle{firstpage}[base]{
  \fancyhead[OL, ER]{\small \thecoursesubj{}~\thecoursenumb~(\thecourseterm~\thecourseyear)}
  \fancyhead[C]{\small\firstpageheader{}}
  \renewcommand{\headrulewidth}{.4pt}
  \ifdraft{
      \fancyhead[OL,ER]{\small\textcolor{red}{\textbf{DRAFT MODE ON}}}
    }
}

% for syllabus
\fancypagestyle{syllabus}[firstpage]{
  \fancyhead[C]{\small Syllabus}
}

% ------------------------------------------------------------
%
%           PACKAGES
%
% ------------------------------------------------------------
% colours
\input{./colours.tex.preamble}

% math
\usepackage{amsmath, amsthm, amssymb, amsfonts}
\usepackage{cancel}
\everymath{\displaystyle}

% typography
\usepackage{fontspec}
\usepackage{microtype} 
\usepackage{parskip}
\usepackage{ragged2e}

% embedded markups
\usepackage{markdown}
\usepackage[outputdir=./build/aux, draft]{minted}
\newmintinline{python}{python3, bgcolor=gray!10}
\newminted{python}{python3, bgcolor=gray!5}

% subfiles
\usepackage{refcount, xr, subfiles}

% links and references
\usepackage[hidelinks, pdfusetitle]{hyperref}
\renewcommand{\UrlFont}{\footnotesize\ttfamily}

% lists
\usepackage[inline]{enumitem}

% figures
\usepackage{wrapfig}
\usepackage{float}

% plots
\input{./tikz.tex.preamble}

% tables
\usepackage{booktabs, multirow}

% framed callout boxes
\usepackage[framemethod=tikz]{mdframed}
\mdfdefinestyle{wide}{
  % userdefinedwidth=0.95\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
}
\mdfdefinestyle{simple}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
  startinnercode={\linespread{1.5}\selectfont}
}

\mdfdefinestyle{simple-compact}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
}

\mdfdefinestyle{sidenote}{
  userdefinedwidth=0.3\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=right,
  topline=false,
  rightline=false,
  bottomline=false,
  startinnercode={\footnotesize}
}

\mdfdefinestyle{withref}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=0.25em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
  startinnercode={\linespread{1.5}\selectfont}
}

\mdfdefinestyle{withref-compact}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=0.25em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
}

\surroundwithmdframed[style=simple-compact]{thm}
\surroundwithmdframed[style=simple-compact]{definition}
\surroundwithmdframed[style=simple-compact]{method}

% fonts
\usepackage[mathcal]{euscript}
\usepackage{fontawesome5}

% section titles
\usepackage[sc,center,tiny]{titlesec}
\titlelabel{\thetitle.\;}
% \titleformat{⟨command⟩}[⟨shape⟩]{⟨format⟩}{⟨label⟩}{⟨sep⟩}{⟨before-code⟩}[⟨after-code⟩]
\titleformat{\subsection}{\bfseries}{\thesubsection}{1ex}{}{}
\titleformat{\subsubsection}{}{\thesubsection}{1ex}{}{}


% ------------------------------------------------------------
%
%           Math
%
% ------------------------------------------------------------
\numberwithin{equation}{chapter}
\theoremstyle{definition}
\newtheorem{stmt}{Statement}[chapter]
\newtheorem{thm}[stmt]{Theorem}
\newtheorem{example}[stmt]{Example}
\newtheorem{computing}[stmt]{Scientific Computing}
\newtheorem{definition}[stmt]{Definition}
\newtheorem{method}[stmt]{Method}

\newcommand{\textbook}[1]{\noindent{} {\footnotesize \faBookReader{} #1 \hfill}}

% better looking symbols
\renewcommand{\epsilon}{\varepsilon}
\renewcommand{\emptyset}{\varnothing}
\renewcommand{\arctan}{\tan^{-1}}
\renewcommand{\arcsin}{\sin^{-1}}
\renewcommand{\arccos}{\cos^{-1}}


% ------------------------------------------------------------
%
%           Fill in the blanks
%
% ------------------------------------------------------------
\usepackage{suffix}
\newcommand{\blanklines}[1]{
  \par
  % scale ever so slightly to avoid LaTeX warnings
  \includegraphics[scale=0.995]{./standalones/build/grid_#1_by_40.pdf}
  \smallbreak
}

% ------------------------------------------------------------
%
%         Custom commands
%
% ------------------------------------------------------------
\newcommand{\todo}[1]{\textcolor{magenta}{#1}}

\newenvironment{objective}{
  \faStar{} \textbf{Learning objectives}.
}{
}

% ------------------------------------------------------------
%
%           Make a week environment
%
% ------------------------------------------------------------
\newcounter{week}
\setcounter{week}{0}
\newenvironment{week}[1]{
  \refstepcounter{week}

  % befor code
  % chapter and section numbering
  \setcounter{chapter}{\theweek}
  \setcounter{section}{0}
  \setcounter{stmt}{0}

  % add to TOC
  \phantomsection{}\label{week\theweek}
  \addcontentsline{toc}{chapter}{Week~\theweek~(#1)}

  \renewcommand{\firstpageheader}{Week~\theweek~(#1)}
  \thispagestyle{firstpage}
}{
  \clearpage{\thispagestyle{empty}\cleardoublepage}
  \renewcommand{\firstpageheader}{}
  \directlua{weeks[\theweek] = \the\value{page}}
}

% ------------------------------------------------------------
%
%         Keep track of page numbering of the weeks
%
% ------------------------------------------------------------
\usepackage{luacode}
\directlua{weeks = {}}

\begin{document}
% --------------------
% 
% TITLE PAGE
% 
% --------------------
\begin{titlepage}
  \thispagestyle{empty}
  \huge

  \begin{center}
    % title
    \phantom{top}
    \vspace{1in}

    {\Huge\bfseries \thecoursetitle}

    \vspace{1cm}
    \theauthor

    \theinstitute
    \vfill{}

    \thecourseterm~\thecourseyear

    \vspace{2in}
  \end{center}

  % creaate a blank page
  \clearpage{\thispagestyle{empty}\cleardoublepage}
\end{titlepage}
\directlua{titlepage = \the\value{page} - 1}

% --------------------
% 
% FRONT MATTER
% 
% --------------------
\frontmatter{}
\pagenumbering{roman}

\renewcommand{\contentsname}{Table of Contents}
\phantomsection{} \label{toc}
\addcontentsline{toc}{chapter}{\contentsname}
\tableofcontents{}
\clearpage

\clearpage{\thispagestyle{empty}\cleardoublepage}
\restoregeometry{}
\directlua{frontmatter = \the\value{page} - 1}


%--------------------
% 
% MAIN MATTER
% 
% --------------------
\mainmatter{}

\begin{week}{January 6 to 10}
  \subfile{./lessons/introduction.tex} \clearpage
  \subfile{./lessons/intro-dimensional-homogeneity.tex} \clearpage
  \subfile{./lessons/intro-log-log-transformation.tex} \clearpage
  \subfile{./lessons/intro-toucan.tex} \clearpage
  \subfile{./lessons/intro-allometry.tex} \clearpage
\end{week}

\begin{week}{January 13 to 17}
  \subfile{./lessons/recursion-intro.tex} \clearpage
  \subfile{./lessons/recursion-models.tex} \clearpage
  \subfile{./lessons/recursion-techniques.tex} \clearpage
\end{week}

\begin{week}{January 20 to 24}
  \subfile{./lessons/diff-eq-intro.tex} \clearpage
  \subfile{./lessons/diff-eq-models.tex} \clearpage
  \subfile{./lessons/diff-eq-techniques-overview.tex} \clearpage
  \subfile{./lessons/diff-eq-classification.tex} \clearpage
  \subfile{./lessons/diff-eq-solutions.tex} \clearpage
  \subfile{./lessons/diff-eq-logistic.tex} \clearpage
\end{week}

\begin{week}{January 27 to 31}
  \subfile{./lessons/diff-eq-linear-first-order.tex} \clearpage
  \subfile{./lessons/diff-eq-applications.tex} \clearpage
\end{week}

\begin{week}{February 3 to 7}
  \subfile{./lessons/diff-eq-technique-change-of-variables.tex} \clearpage
  \subfile{./lessons/diff-eq-phase-line-plots.tex} \clearpage
  \subfile{./lessons/scientific-computing.tex}
\end{week}

\begin{week}{February 10 to 14}
  \subfile{./lessons/probability-intro.tex} \clearpage
  \subfile{./lessons/probability-conditional.tex} \clearpage
  \subfile{./lessons/probability-errors.tex} \clearpage
\end{week}

\begin{week}{February 17 to 21}
  \subfile{./lessons/diff-eq-summary.tex}
\end{week}

\begin{week}{February 24 to 28}
  \subfile{./lessons/probability-monte-carlo.tex} \clearpage
\end{week}

\begin{week}{March 3 to 7}
  \subfile{./lessons/probability-expectation-and-variance.tex} \clearpage
  \subfile{./lessons/probability-working-with-data.tex} \clearpage
\end{week}

\begin{week}{March 10 to 14}
  \subfile{./lessons/linalg-vectors.tex}
  \subfile{./lessons/linalg-functions-of-vectors.tex}
  \subfile{./lessons/linalg-vector-fields.tex}
\end{week}

\begin{week}{March 17 to 21}
  \section{Sections 7.1 and 7.2, eigenvalues and eigenvectors}
\end{week}

\begin{week}{March 24 to 28}
  \section{Section 7.3, applications to age-structured populations}
  \section{Section 8.1, Systems of differential equations}
\end{week}

\begin{week}{March 31 to April 4}
  \section{Section 8.2, Systems of differential equations}
\end{week}

%--------------------
% 
% BACK MATTER
% 
% --------------------
\backmatter{}
\begin{luacode}
  local offset = titlepage + frontmatter
  local prev = offset + 1
  for i, pagenum in pairs(weeks) do
  local f = io.open(string.format("./publish/week%d.tex", i), "w")
  local a = prev
  local b = pagenum + offset - 1
  local s = string.format("\\includepdf[pages=%d-%d]{../build/main.pdf}", a, b)

  f:write("\\documentclass{article}")
  f:write("\\usepackage{pdfpages}")
  f:write("\\begin{document}")
  f:write(s)
  f:write("\\end{document}")
  f:close()

  prev = b + 1
  end
\end{luacode}
\end{document}
